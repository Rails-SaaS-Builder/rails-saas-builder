<%= form_with model: plan, url: url, method: method, local: true, scope: :plan do |f| %>
  <% if plan.errors.any? %>
    <div class="mb-4 p-4 bg-rsb-danger-bg border border-rsb-danger rounded-rsb">
      <strong class="text-rsb-danger-text"><%= pluralize(plan.errors.count, "error") %> prohibited this plan from being saved:</strong>
      <ul class="mt-2 pl-5 list-disc text-rsb-danger-text text-sm">
        <% plan.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%# Basic Fields %>
  <div class="mb-4">
    <%= f.label :name, class: "block text-sm font-medium mb-1" %>
    <%= f.text_field :name, required: true, placeholder: "Pro Plan", id: "plan_name_field",
        class: "w-full px-3 py-2 border border-rsb-border rounded-rsb text-sm bg-rsb-card focus:outline-none focus:ring-2 focus:ring-rsb-primary" %>
  </div>

  <div class="mb-4">
    <%= f.label :slug, class: "block text-sm font-medium mb-1" %>
    <%= f.text_field :slug, required: true, placeholder: "pro-plan", id: "plan_slug_field",
        class: "w-full px-3 py-2 border border-rsb-border rounded-rsb text-sm bg-rsb-card focus:outline-none focus:ring-2 focus:ring-rsb-primary" %>
    <p class="mt-1 text-xs text-rsb-muted">Auto-generated from name. Use lowercase letters, numbers, hyphens, and underscores only.</p>
  </div>

  <div class="mb-4">
    <%= f.label :interval, class: "block text-sm font-medium mb-1" %>
    <%= f.select :interval, [["Monthly", "monthly"], ["Yearly", "yearly"], ["Lifetime", "lifetime"], ["One-time", "one_time"]],
        {}, class: "w-full px-3 py-2 border border-rsb-border rounded-rsb text-sm bg-rsb-card focus:outline-none focus:ring-2 focus:ring-rsb-primary" %>
  </div>

  <div class="mb-4">
    <%= f.label :price_cents, "Price (cents)", class: "block text-sm font-medium mb-1" %>
    <%= f.number_field :price_cents, required: true, min: 0, placeholder: "2900",
        class: "w-full px-3 py-2 border border-rsb-border rounded-rsb text-sm bg-rsb-card focus:outline-none focus:ring-2 focus:ring-rsb-primary" %>
    <p class="mt-1 text-xs text-rsb-muted">Enter price in cents. Example: 2900 = $29.00</p>
  </div>

  <div class="mb-4">
    <%= f.label :currency, class: "block text-sm font-medium mb-1" %>
    <%= f.text_field :currency, required: true, placeholder: "usd",
        class: "w-full px-3 py-2 border border-rsb-border rounded-rsb text-sm bg-rsb-card focus:outline-none focus:ring-2 focus:ring-rsb-primary" %>
  </div>

  <div class="mb-4">
    <label class="flex items-center gap-2">
      <%= f.check_box :active, class: "rounded border-rsb-border" %>
      <span class="text-sm">Active plan</span>
    </label>
    <p class="mt-1 text-xs text-rsb-muted">Make this plan available for selection.</p>
  </div>

  <%# Features Section (dynamic) %>
  <div class="mb-4">
    <label class="block text-sm font-semibold mb-2">Features</label>
    <div id="features-container" class="space-y-2">
      <% if plan.features.present? && plan.features.any? %>
        <% plan.features.each do |key, value| %>
          <div class="flex items-center gap-2">
            <input type="text" value="<%= key %>" placeholder="Feature name" readonly
                   class="flex-1 px-3 py-2 border border-rsb-border rounded-rsb text-sm bg-rsb-bg">
            <label class="flex items-center gap-1 whitespace-nowrap">
              <input type="hidden" name="plan[features][<%= key %>]" value="false">
              <input type="checkbox" name="plan[features][<%= key %>]" value="true" <%= 'checked' if value %> class="rounded border-rsb-border">
              <span class="text-sm">Enabled</span>
            </label>
            <button type="button" onclick="this.parentElement.remove()"
                    class="px-2 py-1 bg-rsb-danger text-white rounded-rsb text-xs font-medium hover:opacity-90 transition-colors">Remove</button>
          </div>
        <% end %>
      <% end %>
    </div>
    <button type="button" id="add-feature-btn"
            class="mt-2 inline-flex items-center px-3 py-1.5 border border-rsb-border text-rsb-text rounded-rsb text-xs font-medium hover:bg-rsb-bg transition-colors">+ Add Feature</button>
  </div>

  <%# Limits Section (dynamic) %>
  <div class="mb-4">
    <label class="block text-sm font-semibold mb-2">Limits</label>
    <div id="limits-container" class="space-y-2">
      <% if plan.limits.present? && plan.limits.any? %>
        <% plan.limits.each do |key, value| %>
          <div class="flex items-center gap-2">
            <input type="text" value="<%= key %>" placeholder="Limit name" readonly
                   class="flex-1 px-3 py-2 border border-rsb-border rounded-rsb text-sm bg-rsb-bg">
            <input type="number" name="plan[limits][<%= key %>]" value="<%= value %>" placeholder="Value"
                   class="w-30 px-3 py-2 border border-rsb-border rounded-rsb text-sm">
            <button type="button" onclick="this.parentElement.remove()"
                    class="px-2 py-1 bg-rsb-danger text-white rounded-rsb text-xs font-medium hover:opacity-90 transition-colors">Remove</button>
          </div>
        <% end %>
      <% end %>
    </div>
    <button type="button" id="add-limit-btn"
            class="mt-2 inline-flex items-center px-3 py-1.5 border border-rsb-border text-rsb-text rounded-rsb text-xs font-medium hover:bg-rsb-bg transition-colors">+ Add Limit</button>
  </div>

  <%# Description (from metadata) %>
  <div class="mb-4">
    <label for="plan_metadata_description" class="block text-sm font-medium mb-1">Description</label>
    <textarea name="plan[metadata][description]" id="plan_metadata_description" rows="3"
              placeholder="Describe this plan..."
              class="w-full px-3 py-2 border border-rsb-border rounded-rsb text-sm bg-rsb-card focus:outline-none focus:ring-2 focus:ring-rsb-primary"><%= plan.metadata&.dig("description") %></textarea>
  </div>

  <%# Actions %>
  <div class="flex gap-3 mt-6">
    <button type="submit"
            class="px-4 py-2 bg-rsb-primary text-rsb-primary-text rounded-rsb text-sm font-medium hover:bg-rsb-primary-hover transition-colors"><%= plan.new_record? ? "Create Plan" : "Update Plan" %></button>
    <a href="/admin/plans"
       class="px-4 py-2 border border-rsb-border text-rsb-text rounded-rsb text-sm hover:bg-rsb-bg transition-colors">Cancel</a>
  </div>
<% end %>

<script>
  // Auto-generate slug from name
  document.addEventListener('DOMContentLoaded', function() {
    var nameField = document.getElementById('plan_name_field');
    var slugField = document.getElementById('plan_slug_field');

    if (nameField && slugField) {
      nameField.addEventListener('input', function() {
        if (!slugField.dataset.manuallyEdited) {
          var slug = this.value
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-|-$/g, '');
          slugField.value = slug;
        }
      });

      slugField.addEventListener('input', function() {
        slugField.dataset.manuallyEdited = 'true';
      });
    }
  });

  // Add feature row
  document.getElementById('add-feature-btn').addEventListener('click', function() {
    var container = document.getElementById('features-container');
    var timestamp = Date.now();
    var row = document.createElement('div');
    row.className = 'flex items-center gap-2';
    row.innerHTML =
      '<input type="text" id="feature-key-' + timestamp + '" placeholder="Feature name (e.g., sso)" ' +
        'class="flex-1 px-3 py-2 border border-rsb-border rounded-rsb text-sm">' +
      '<label class="flex items-center gap-1 whitespace-nowrap">' +
        '<input type="hidden" id="feature-hidden-' + timestamp + '" value="false">' +
        '<input type="checkbox" id="feature-value-' + timestamp + '" value="true" class="rounded border-rsb-border">' +
        '<span class="text-sm">Enabled</span>' +
      '</label>' +
      '<button type="button" onclick="this.parentElement.remove()" ' +
        'class="px-2 py-1 bg-rsb-danger text-white rounded-rsb text-xs font-medium hover:opacity-90 transition-colors">Remove</button>';
    container.appendChild(row);

    // When the key input changes, update the name attributes
    var keyInput = row.querySelector('#feature-key-' + timestamp);
    var hiddenInput = row.querySelector('#feature-hidden-' + timestamp);
    var checkboxInput = row.querySelector('#feature-value-' + timestamp);

    keyInput.addEventListener('input', function() {
      var key = this.value.trim();
      if (key) {
        hiddenInput.name = 'plan[features][' + key + ']';
        checkboxInput.name = 'plan[features][' + key + ']';
      } else {
        hiddenInput.name = '';
        checkboxInput.name = '';
      }
    });
  });

  // Add limit row
  document.getElementById('add-limit-btn').addEventListener('click', function() {
    var container = document.getElementById('limits-container');
    var timestamp = Date.now();
    var row = document.createElement('div');
    row.className = 'flex items-center gap-2';
    row.innerHTML =
      '<input type="text" id="limit-key-' + timestamp + '" placeholder="Limit name (e.g., api_calls)" ' +
        'class="flex-1 px-3 py-2 border border-rsb-border rounded-rsb text-sm">' +
      '<input type="number" id="limit-value-' + timestamp + '" placeholder="Value" ' +
        'class="w-30 px-3 py-2 border border-rsb-border rounded-rsb text-sm">' +
      '<button type="button" onclick="this.parentElement.remove()" ' +
        'class="px-2 py-1 bg-rsb-danger text-white rounded-rsb text-xs font-medium hover:opacity-90 transition-colors">Remove</button>';
    container.appendChild(row);

    // When the key input changes, update the name attribute on the value input
    var keyInput = row.querySelector('#limit-key-' + timestamp);
    var valueInput = row.querySelector('#limit-value-' + timestamp);

    keyInput.addEventListener('input', function() {
      var key = this.value.trim();
      if (key) {
        valueInput.name = 'plan[limits][' + key + ']';
      } else {
        valueInput.name = '';
      }
    });
  });
</script>
